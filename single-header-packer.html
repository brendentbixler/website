<meta charset="utf-8" lang="en">
<html><body>

<!-- Show help if no URL params are provided -->

<link rel="stylesheet" id="style" type="text/css" href="oldstyle.css">

<div id="help" style="margin:0;padding:0;visibility:hidden;">
<div style="float:left;"><a href="http://apoorvaj.io/">Home</a></div>
<div style="float:right;"><a href="about.html">About</a></div>
<div style="clear:both"></div><br>
<hr style="margin: -1em 0 2em 0;"/>

<title>Single-Header Packer</title>
<div class="title">Single-Header Packer</div>
<div class="subtitle">02-Apr-2018</div>

<p>End-users often like single header C/C++ libraries because they require very little work to integrate into their projects. However, a single file can be difficult to read and maintain. This is a web-based tool to get the best of both worlds.</p>

<h1>Contents</h1>
<ol>
    <li><a href="#example">Example</a></li>
    <li><a href="#features">Features</a></li>
    <li><a href="#how_this_works">How this works</a></li>
    <li><a href="#caveats">Caveats</a></li>
    <li><a href="#license">License</a></li>
    <li><a href="#building_the_url">Building the URL</a></li>
</ol>

<h1 id="example">1. Example</h1>
<p><a href="https://github.com/vurtun/nuklear">Nuklear</a> is an awesome C library whose source code is currently over 25,000 linesâ€”all contained in a single header file. I forked the library and split it into multiple files.</p>
<ul>
    <li><a href="https://github.com/ApoorvaJ/nuklear">My multi-file fork of Nuklear on GitHub</a></li>
    <li><mark><a href="http://apoorvaj.io/single-header-packer.html?macro=NK&pre=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/HEADER&pub=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear.h&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_internal.h&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_buffer.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_button.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_chart.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_checkbox.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_color.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_color_picker.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_combo.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_context.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_contextual.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_draw.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_edit.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_font.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_group.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_image.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_input.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_layout.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_menu.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_menubar.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_misc.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_option.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_page_element.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_panel.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_pool.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_popup.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_progress.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_property.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_scrollbar.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_selectable.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_slider.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_string.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_style.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_table.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_text.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_tooltip.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_tree.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_utf8.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_util.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_widget.c&priv=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/nuklear_window.c&post=https://raw.githubusercontent.com/ApoorvaJ/nuklear/master/LICENSE">Single-Header Packer URL for my fork</a></mark><code> &lt;--</code> Click this to generate single header file from multi-file GitHub repo
</ul>

<h1 id="features">2. Features</h1>
<ul>
    <li>Multi-file development, single-header usage for those who want it</li>
    <li>Each file can be picked from any branch, commit, or release</li>
    <li>Requires very little maintenance from you as a library owner</li>
    <li>Self-contained static web-page</li>
    <li>Simple and public domain</li>
</ul>


<h1 id="how_this_works">3. How this works</h1>
<ol>
    <li>As a library developer, you maintain a multi-file repository.</li>
    <li>You build a URL using the form below, and put it on your project page.</li>
    <li>When invoked with that URL, this page generates a single-header file from your multi-file project.</li>
    <li>The library user clicks on the URL you provide, copy-pastes the generated single-header code into a file, and begins using your library</li>
</ol>

<p>The URL-builder below takes the following inputs:</p>
<ol>
    <li>The <b>macro prefix</b> is used to generate enclosing macro defines for header guards and the implementation guard</li>
    <li><b>Intro and outro files</b>, if specified, are inserted as block comments at the beginning and the end of the file. You can use these to assemble usage instructions, licensing and release notes from text or markdown files.</li>
    <li><b>Public headers</b> define the public interface of the library.</li>
    <li><b>Source files and private headers</b> are only included in the implementation section of the single-header library.</li>
</ol>

This is how the code is packed into a single file:
<pre style="margin-left:2em;">
/*
<font color="grey">[intro file contents]</font>
*/

#ifndef <font color="grey">[macro prefix]</font>_SINGLE_HEADER
#define <font color="grey">[macro prefix]</font>_SINGLE_HEADER
<font color="grey">[public header file contents]</font>
#endif /* <font color="grey">[macro prefix]</font>_SINGLE_HEADER */

#ifdef <font color="grey">[macro prefix]</font>_IMPLEMENTATION
<font color="grey">[private header and source file contents]</font>
#endif /* <font color="grey">[macro prefix]</font>_IMPLEMENTATION */

/*
<font color="grey">[outro file contents]</font>
*/
</pre>

<h1 id="caveats">4. Caveats</h1>

<ul>
    <li>Ordering is very important. Generally, you'll want to list private headers before any of the source files.</li>
    <li><code>#include</code> statements are omitted for files already included in public and private headers. e.g. if headers contain a file called <code>my_lib.h</code>, then all instances of <code>#include "my_lib.h"</code> and <code>#include &lt;my_lib.h&gt;</code> will be omitted from source files and private headers.</li>
    <li>Ultimately, this is simple concatenation with minimal processing. Things such as extern declarations and actual declarations may end up in the same file after concatenation, and will lead to C/C++ code which will not compile. The library developer will need to handle this properly.</li>
    <li>This webpage is cumbersome to use on local files. <a href="https://github.com/ApoorvaJ/libs/blob/master/scripts/single_header_packer.py">This Python script</a> produces the same output as this web page, and can be used for local files and it is handy for automated testing.</li>
</ul>

<h1 id="license">5. License</h1>

<p>This web page is largely self-contained, only relying on an external style-sheet. I am making the contents of this web page and the code behind it public domain. You are encouraged to host a copy of this page on your own website, and modify it as you see fit.</p>

<h1 id="building_the_url">6. Building the URL</h1>
<p>Macro prefix:<br>
<input type="text" id="macro" placeholder="MY_LIB" style="width:100%" oninput="gen_url()"></p>

<p>Intro comment files <i>(optional)</i>:<br>
<textarea id="pre_files" style="width:100%;height:60px;" placeholder="https://raw.githubusercontent.com/ApoorvaJ/my_lib/README.txt" oninput="gen_url()"></textarea></p>

<p>Public headers:<br>
<textarea id="pub_files" style="width:100%;height:60px;" placeholder="https://raw.githubusercontent.com/ApoorvaJ/my_lib/my_public_header.h" oninput="gen_url()"></textarea></p>

<p>Source files and private headers:<br>
<textarea id="priv_files" style="width:100%;height:100px;" placeholder="https://raw.githubusercontent.com/ApoorvaJ/my_lib/internal.h&#10;https://raw.githubusercontent.com/ApoorvaJ/my_lib/source.c" oninput="gen_url()"></textarea></p>

<p>Outro comment files <i>(optional)</i>:<br>
<textarea id="post_files" style="width:100%;height:60px;" placeholder="https://raw.githubusercontent.com/ApoorvaJ/my_lib/LICENSE.txt" oninput="gen_url()"></textarea oninput="gen_url()"></p>

<p><b>Resultant URL:</b><br>
<mark><a id="res_url" href=""></a></mark></p>

<!-- Footer -->
<hr style="margin: 2em 0 5 0;"/>
<center>
<a href="mailto:apoorvaj@apoorvaj.io">Email</a> / <a href="https://twitter.com/ApoorvaJ">Twitter</a> / <a href="https://github.com/ApoorvaJ">GitHub</a> / <a href="cv.html">CV</a>
</center>

</div>

<!-- URL building, parsing and processing -->

<script type="text/javascript">

/* URL building
   ------------ */ 
function multiline_to_url(key, str) {
    var toks = str.split("\n");
    var res = "";
    for (i = 0; i < toks.length; i++) {
        if (toks[i].trim() == "") {
            continue;
        }
        res += "&" + key + "=" + encodeURI(toks[i]);
    }
    return res;
}

function gen_url() {
    var res_url = document.URL.replace(/#.*$/, "");

    res_url += "?macro=" + encodeURI(document.getElementById("macro").value);
    res_url += multiline_to_url("pre", document.getElementById("pre_files").value);
    res_url += multiline_to_url("pub", document.getElementById("pub_files").value);
    res_url += multiline_to_url("priv", document.getElementById("priv_files").value);
    res_url += multiline_to_url("post", document.getElementById("post_files").value);

    var a = document.getElementById("res_url");
    a.href = a.text = res_url;
}

gen_url();

/* URL parsing and processing
   -------------------------- */

var macro = "";
var pre_urls = [];
var pub_urls = [];
var priv_urls = [];
var post_urls = [];

function parse_url() {
    var query = location.search.substr(1);
    if (query.length == 0) {
        return null;
    }
    var result = {};
    query.split("&").forEach(function(part) {

        var item = part.split("=");
        var k =  String(item[0]);
        var v = decodeURIComponent(item[1]);

        if (k === "macro") {
            macro = item[1];
        } else if (k === "pre") {
            pre_urls.push(v);
        } else if (k === "pub") {
            pub_urls.push(v);
        } else if (k === "priv") {
            priv_urls.push(v);
        } else if (k === "post") {
            post_urls.push(v);
        }
    });
}

function htmlify(str) {
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

function filename(path) {
    return path.replace(/^.*[\\\/]/, '');

}

function omit_filename(str, filename) {
    console.log("omitting " + filename);
    var re1 = new RegExp("#include \"" + filename + "\"");
    var re2 = new RegExp("#include <" + filename + ">");
    return str.replace(re1, "").replace(re2, "");
}

function omit_includes(str) {
    for (i = 0; i < pub_urls.length; i++) {
        var file = filename(pub_urls[i]);
        if (file.includes(".h")) {
            str = omit_filename(str, file);
        }
    }
    for (i = 0; i < priv_urls.length; i++) {
        var file = filename(priv_urls[i]);
        if (file.includes(".h")) {
            str = omit_filename(str, file);
        }
    }
    return str;
}

function process_url() {

    parse_url();

    if (macro === "") {
        document.getElementById("help").style.visibility = 'visible';
        return;
    }

    var all_urls = [];
    all_urls = all_urls
        .concat(pre_urls)
        .concat(pub_urls)
        .concat(priv_urls)
        .concat(post_urls);

    var p = all_urls.map(url => fetch(url).then(y => y.text()));

    Promise.all(p).then(results => {

        var i = 0
        var str = "<pre>"

        // pre
        if (pre_urls.length > 0) {
            str += "/*\n";
        }
        for (j = 0; j < pre_urls.length; j++) {
            str += htmlify(results[i++]);
        }
        if (pre_urls.length > 0) {
            str += "*/\n\n";
        }

        // pub
        var m = macro + "_SINGLE_HEADER"
        str += "#ifndef " + m + "\n#define " + m + "\n";
        for (j = 0; j < pub_urls.length; j++) {
            str += htmlify(results[i++]);
        }
        str += "#endif /* " + m + " */\n\n";

        // priv
        m = macro + "_IMPLEMENTATION"
        str += "#ifdef " + m + "\n";
        for (j = 0; j < priv_urls.length; j++) {
            str += htmlify(omit_includes(results[i++]));
        }
        str += "#endif /* " + m + " */\n\n";

        // post
        if (post_urls.length > 0) {
            str += "/*\n";
        }
        for (j = 0; j < post_urls.length; j++) {
            str += htmlify(results[i++]);
        }
        if (post_urls.length > 0) {
            str += "*/\n\n";
        }

        str += "</pre>";

        document.getElementById("help").style.display = 'none';
        document.body.innerHTML += str;
        document.getElementById("style").disabled = true;
    }).catch(function(err){
        console.log(err);
        var str = err + "<p>One or more of the following links may be broken:</p><ul>"
        for (i = 0; i < all_urls.length; i++) {
            str += "<li><a href=\"" + all_urls[i] + "\">" + all_urls[i] + "</a></li>";
        }
        str += "</ul>"
        document.getElementById("help").style.display = 'none';
        document.body.innerHTML += str;
        // document.getElementById("style").disabled = true;
    });
}

process_url();

</script>

<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18556434-3', 'auto'); ga('send', 'pageview'); </script>

</body></html>